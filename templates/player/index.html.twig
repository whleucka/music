<div class="bg-light d-flex align-items-center justify-content-center">
    <span id="cover" class="d-flex align-items-center">
        <img src="{{ player.cover }}" alt="cover" />
    </span>
    {% if player.source %}
    <span id="info" class="d-none d-md-block">
        <div class="d-flex flex-column ps-2">
            <div class="truncate" title="{{ player.title|raw }}"><strong>{{ player.title|raw }}</strong></div>
            <div class="truncate text-muted" title="{{ player.artist|raw }}"><small>{{ player.artist|raw }}</small></div>
        </div>
    </span>
    {% endif %}
    <span id="controls" class="p-1 d-flex flex-column align-items-center justify-content-center w-100">
        <div id="track-progress" class="progress w-100 mt-3">
            <div class="progress-bar track-progress" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
            <div class="progress-bar buffer" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div class="d-flex">
            <!-- <button class="btn" id="repeat"><i class="bi bi-repeat"></i></button> -->
            <button class="btn" id="prev-track" hx-get="/player/prev-track" hx-trigger="click, prevTrack from:body" hx-swap="none"><i class="bi bi-skip-start"></i></button>
            <button class="btn" id="rewind" onClick="seekBackward()"><i class="bi bi-rewind"></i></button>
            <button class="btn" id="play" onClick="playPause()"><i class="bi bi-play"></i></button>
            <button class="btn" id="fast-forward" onClick="seekForward()"><i class="bi bi-fast-forward"></i></button>
            <button class="btn" id="next-track" hx-get="/player/next-track" hx-trigger="click, nextTrack from:body" hx-swap="none"><i class="bi bi-skip-end"></i></button>
            <button class="btn" id="shuffle"><i class="bi bi-shuffle"></i></button>
        </div>
    </span>
    {% if player.source %}
    <span id="volume" class="px-5 d-none d-lg-block">
        <div class="d-flex align-items-center">
            <i class="bi bi-volume-up me-1"></i>
            <div id="volume-progress" class="progress w-100">
                <div class="progress-bar" role="progressbar" style="width: 100%" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        </div>
    </span>
    {% endif %}
    <audio id="audio" src="{{ player.source }}">Your browser does not support the audio element.</audio>
</div>

<script>
    var player = document.getElementById("audio");
    var playButton = document.querySelector("#play");
    var trackProgress = document.querySelector(".track-progress");
    var bufferProgress = document.querySelector(".buffer");
    var defaultSkipTime = 10;

    var updateProgress = () => {
        if (!player.paused && !player.ended) {
            if (player.readyState >= 2) { // Check if player has loaded some data
                let progress = (player.currentTime / player.duration) * 100;
                setTrackProgress(progress);

                if (player.buffered.length > 0) {
                    let bufferedEnd = player.buffered.end(player.buffered.length - 1);
                    let buffer = (bufferedEnd / player.duration) * 100;
                    setBufferProgress(buffer - progress);
                }

                requestAnimationFrame(updateProgress);
            }
        }
    };

    var decodeHTML = (html) => {
        var txt = document.createElement("textarea");
        txt.innerHTML = html;
        return txt.value;
    }

    var updateMetaData = () => {
        let artwork = [
            { src: '{{ player.cover }}', sizes: '192x192', type: 'image/png' }
        ];
        navigator.mediaSession.metadata = new MediaMetadata({
            title: decodeHTML('{{ player.title|raw }}'),
            artist: decodeHTML('{{ player.artist|raw }}'),
            album: decodeHTML('{{ player.album|raw }}'),
            artwork
        });
        updatePositionState();
    }

    var updatePositionState = () => {
        if ('setPositionState' in navigator.mediaSession) {
            navigator.mediaSession.setPositionState({
                duration: player.duration,
                playbackRate: player.playbackRate,
                position: player.currentTime
            });
        }
    }

    var playPause = () => {
        if (player.paused) {
            play();
        } else {
            pause();
        }
    }

    var play = async () => {
        player.play()
        .then(_ => updateMetaData())
        .catch(err => console.log(err));
    }

    var pause = async () => {
        player.pause();
    }

    var setTrackProgress = (pct) => {
        trackProgress.style.width = pct + '%';
    }

    var setBufferProgress = (pct) => {
        bufferProgress.style.width = pct + '%';
    }

    var setActiveTrack = () => {
        const currentTrack = document.getElementById('{{ player.id }}');
        if (currentTrack) currentTrack.classList.toggle("active");
        currentTrack.focus();
    }

    var removeActiveTrack = () => {
        const trackRows = document.querySelectorAll(".track-row");
        trackRows.forEach((row) => {
            row.classList.remove("active");
        });
    }

    var seekForward = () => {
        const skipTime = event.seekOffset || defaultSkipTime;
        player.currentTime = Math.min(player.currentTime + skipTime, player.duration);
        updatePositionState();
    }

    var seekBackward = () => {
        const skipTime = event.seekOffset || defaultSkipTime;
        player.currentTime = Math.max(player.currentTime - skipTime, 0);
        updatePositionState();
    }

    // Listeners
    player.onplay  = () => {
        navigator.mediaSession.playbackState = 'playing';
        playButton.innerHTML = `<i class="bi bi-pause"></i>`;
        trackProgress.classList.remove("disable");
        removeActiveTrack();
        setActiveTrack();
    }

    player.onplaying = () => {
        requestAnimationFrame(updateProgress);
    }

    player.onpause = () => {
        navigator.mediaSession.playbackState = 'paused';
        playButton.innerHTML = `<i class="bi bi-play"></i>`;
        trackProgress.classList.add("disable");
    }

    player.onended = () => {
        setTrackProgress(0);
        setBufferProgress(8);
        removeActiveTrack();
        htmx.trigger("#next-track", "nextTrack");
    }

    player.onloadeddata = () => {
        play();
    }

    navigator.mediaSession.setActionHandler('previoustrack', _ => htmx.trigger("#prev-track", "prevTrack"));
    navigator.mediaSession.setActionHandler('nexttrack', _ => htmx.trigger("#next-track", "nextTrack"));
    navigator.mediaSession.setActionHandler('seekbackward', _ => seekBackward());
    navigator.mediaSession.setActionHandler('seekforward', _ => seekForward());
</script>
